<html lang="en">

<head>

  <meta charset="UTF-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Pop Balloons or Find Love</title>

  <style>

    :root {

      --cell-size: 150px;

      --banner-bg: linear-gradient(135deg, #D21F3C, #FFAE42);

      --hamburger-color: #fff;

      --nav-link-color: #fff;

      --nav-link-hover: #f0f0f0;

    }

    body {

      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;

      margin: 0;

      padding: 0;

      background-color: #f9f9f9;

      display: flex;

      flex-direction: column;

      min-height: 100vh;

    }

    header {

      background: var(--banner-bg);

      color: #fff;

      padding: 15px 30px;

      position: relative;

      box-shadow: 0 2px 8px rgba(0,0,0,0.2);

    }

    .header-top {

      display: flex;

      align-items: center;

      justify-content: space-between;

      position: relative;

    }

    .hamburger {

      display: inline-block;

    }

    #hamburger-btn {

      background: none;

      border: none;

      color: var(--hamburger-color);

      font-size: 28px;

      cursor: pointer;

    }

    .logo h1 {

      margin: 0;

      font-size: 32px;

      letter-spacing: 1px;

    }

    nav.nav-desk {

      display: flex;

      gap: 20px;

    }

    nav.nav-desk a {

      color: var(--nav-link-color);

      text-decoration: none;

      font-size: 16px;

      transition: color 0.3s;

    }

    nav.nav-desk a:hover {

      color: var(--nav-link-hover);

    }

    nav.nav-mobile {

      display: none;

      position: absolute;

      top: 60px;

      left: 0;

      width: 100%;

      background: rgba(0,0,0,0.9);

      flex-direction: column;

      gap: 10px;

      padding: 10px 0;

      z-index: 10;

    }

    nav.nav-mobile a {

      color: var(--nav-link-color);

      padding: 10px 20px;

      text-decoration: none;

      font-size: 18px;

      border-bottom: 1px solid #444;

    }

    nav.nav-mobile a:hover {

      background: #333;

    }

    @media (max-width: 768px) {

      nav.nav-desk {

        display: none;

      }

      nav.nav-mobile {

        display: none;

      }

      nav.nav-mobile.active {

        display: flex;

      }

    }

    #pops-remaining, #keep-count {

      text-align: center;

      font-size: 12px;

      margin-top: 5px;

    }

    #reset-timer {

      text-align: center;

      font-size: 18px;

      margin-top: 10px;

    }

    #ticker {

      width: 100%;

      overflow: hidden;

      background: #ffcc00;

      color: #000;

      font-size: 18px;

      padding: 10px 0;

      position: relative;

    }

    /* Global ticker scrolls immediately */

    #ticker-content {

      white-space: nowrap;

      animation: tickerTapeAnim 12s linear infinite;

      animation-play-state: running;

    }

    @keyframes tickerTapeAnim {

      0% { transform: translateX(100%); }

      100% { transform: translateX(-100%); }

    }

    /* Waitlist status */

    #waitlist-status {

      text-align: center;

      font-size: 14px;

      margin-top: 5px;

    }

    nav#nav-buttons {

      display: flex;

      justify-content: center;

      gap: 20px;

      padding: 10px 0;

      background: #eee;

      box-shadow: inset 0 -2px 4px rgba(0,0,0,0.1);

    }

    nav#nav-buttons button {

      padding: 8px 14px;

      font-size: 16px;

      background: #fff;

      color: #333;

      border: 1px solid #ccc;

      cursor: pointer;

    }

    nav#nav-buttons button:hover {

      background: #f0f0f0;

    }

    /* Balloon container: exactly 12 cells (3 columns x 4 rows) */

    #balloon-container {

      width: calc(var(--cell-size) * 3);

      height: calc(var(--cell-size) * 4);

      border: 1px solid #ccc;

      overflow: hidden;

      position: relative;

      margin: 20px auto;

      background-color: #f0f0f0;

    }

    #grid-container {

      position: relative;

      margin: 0 auto;

    }

    .grid-cell {

      position: absolute;

      width: var(--cell-size);

      height: var(--cell-size);

      box-sizing: border-box;

      border: 1px solid #ccc;

      font-size: 10px;

      color: #666;

      pointer-events: none;

    }

    .grid-cell .cell-label {

      position: absolute;

      bottom: 2px;

      right: 2px;

      background: rgba(255,255,255,0.7);

      padding: 1px 3px;

      border-radius: 3px;

    }

    .highlight {

      border: 3px solid red !important;

      animation: highlightBlink 1s infinite;

    }

    @keyframes highlightBlink {

      0% { border-color: red; }

      50% { border-color: yellow; }

      100% { border-color: red; }

    }

    .rental-label {

      position: absolute;

      top: -20px;

      left: 0;

      width: 100%;

      text-align: center;

      font-size: 14px;

      color: #000;

      background: rgba(255,255,255,0.8);

      pointer-events: none;

    }

    .balloon {

      position: absolute;

      width: 50px;

      height: 50px;

      border-radius: 50%;

      cursor: pointer;

      display: flex;

      align-items: center;

      justify-content: center;

      background: radial-gradient(circle at center, rgba(255,255,255,0.9), rgba(0,150,255,0.3));

      border: 3px solid transparent;

      box-shadow: 0 4px 10px rgba(0,0,0,0.2);

      transition: left 0.1s ease-out, top 0.1s ease-out;

      will-change: left, top;

      z-index: 2;

    }

    .balloon::before {

      content: "";

      position: absolute;

      top: 8px;

      left: 8px;

      width: 30%;

      height: 30%;

      background: rgba(255,255,255,0.6);

      border-radius: 50%;

      transform: rotate(-20deg);

      pointer-events: none;

    }

    .balloon.popped::before {

      display: none;

    }

    .balloon-string {

      position: absolute;

      top: 100%;

      left: 50%;

      transform: translateX(-50%);

      width: 2px;

      height: 30px;

      background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0));

    }

    .kept-icon, .available-icon {

      position: absolute;

      right: 2px;

      bottom: 2px;

      font-size: 16px;

      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);

    }

    .balloon:hover::after {

      content: attr(data-handle);

      position: absolute;

      top: -20px;

      left: 50%;

      transform: translateX(-50%);

      background-color: rgba(0,0,0,0.8);

      color: white;

      padding: 4px 8px;

      border-radius: 4px;

      font-size: 12px;

      white-space: nowrap;

      z-index: 1000;

    }

    .balloon.kept {

      border: 3px solid yellow !important;

    }

    .balloon.popped {

      background: gray;

      border: 3px dashed #ccc;

    }

    .popped-emoji {

      display: block;

      width: 100%;

      text-align: center;

      line-height: 50px;

      font-size: 28px;

    }

    .gender-indicator {

      position: absolute;

      top: -20px;

      left: 50%;

      transform: translateX(-50%);

      font-size: 14px;

      font-weight: bold;

      color: black;

    }

    /* Balloon ticker below each balloon, each with a random duration */

    .balloon-ticker {

      position: absolute;

      width: 100px;

      left: 50%;

      bottom: -25px;

      transform: translateX(-50%);

      background: rgba(0, 0, 0, 0.7);

      color: white;

      font-size: 10px;

      padding: 2px 4px;

      border-radius: 3px;

      overflow: hidden;

      white-space: nowrap;

    }

    .balloon-ticker span {

      display: inline-block;

      animation-play-state: running;

    }

    .modal {

      display: none;

      position: fixed;

      top: 0;

      left: 0;

      width: 100%;

      height: 100%;

      background-color: rgba(0,0,0,0.5);

      z-index: 1000;

    }

    .modal-content {

      background-color: rgba(255,255,255,0.9);

      margin: 10% auto;

      padding: 20px;

      width: 80%;

      max-width: 400px;

      text-align: center;

      border-radius: 10px;

    }

    #settings-content {

      background-color: white;

      max-height: 80vh;

      overflow-y: auto;

      width: 80%;

      max-width: 400px;

      margin: 10% auto;

      padding: 20px;

      border-radius: 10px;

      box-sizing: border-box;

    }

    .close {

      float: right;

      cursor: pointer;

    }

    #signup-content {

      background: linear-gradient(135deg, #ff8c00, #ffd700);

      box-shadow: 0 0 15px rgba(255,140,0,0.7);

      margin: 15% auto;

      padding: 20px;

      width: 80%;

      max-width: 400px;

      text-align: center;

      border-radius: 10px;

      position: relative;

    }

    #profile-handle {

      font-size: 14px;

      color: #333;

    }

    #bottom-banner {

      background-color: #ff6f61;

      color: white;

      text-align: center;

      padding: 10px;

      font-size: 18px;

    }

    footer {

      background-color: #333;

      color: white;

      text-align: center;

      padding: 10px;

      font-size: 14px;

    }

    main { flex: 1; }

    .user-info { text-align: left; }

    .sponsored-balloon {

      background: radial-gradient(circle at center, #ffcccc, #ff0000) !important;

      position: relative;

    }

    .sponsored-balloon::before {

      content: "Ad";

      position: absolute;

      top: 10%;

      left: 50%;

      transform: translateX(-50%);

      color: white;

      font-weight: bold;

    }

    #room-navigation {

      text-align: center;

      margin: 10px 0;

    }

    #room-navigation button {

      padding: 8px 12px;

      margin: 0 5px;

      cursor: pointer;

      font-size: 14px;

    }

    #room-indicator {

      font-size: 16px;

      margin: 0 10px;

    }

    #tutorial-modal .modal-content {

      background-color: white;

      margin: 10% auto;

      padding: 20px;

      width: 80%;

      max-width: 500px;

      text-align: left;

      border-radius: 10px;

    }

  </style>

</head>

<body>

  <!-- Header -->

  <header>

    <div class="header-top">

      <div class="hamburger">

        <button id="hamburger-btn">&#9776;</button>

      </div>

      <div class="logo">

        <h1>Pop Balloons or Find Love</h1>

      </div>

      <div class="header-right">

        <!-- Desktop Navigation Links -->

        <nav class="nav-desk">

          <a href="#" id="tutorial">Tutorial</a>

          <a href="#" id="buy-pops">Buy Pops</a>

          <a href="#" id="buy-keeps">Buy Keeps</a>

          <a href="#" id="subscribe-btn">Subscribe</a>

          <a href="#" id="coffee-bundle-btn">Coffee Bundle</a>

          <a href="#" id="watch-ad-btn">Watch Ad</a>

          <a href="#" id="remove-ads-btn">Remove Ads</a>

          <a href="#" id="login-btn">Login</a>

          <a href="#" id="invite-btn">Invite a Friend</a>

          <a href="#" id="settings">Settings</a>

          <a href="#" id="share-button">Share</a>

          <a href="#" id="leaderboard-toggle">Leaderboard</a>

        </nav>

      </div>

    </div>

    <!-- Mobile Navigation Drawer -->

    <nav class="nav-mobile" id="mobile-nav">

      <a href="#" id="tutorial-mobile">Tutorial</a>

      <a href="#" id="buy-pops-mobile">Buy Pops</a>

      <a href="#" id="buy-keeps-mobile">Buy Keeps</a>

      <a href="#" id="subscribe-btn-mobile">Subscribe</a>

      <a href="#" id="coffee-bundle-btn-mobile">Coffee Bundle</a>

      <a href="#" id="watch-ad-btn-mobile">Watch Ad</a>

      <a href="#" id="remove-ads-btn-mobile">Remove Ads</a>

      <a href="#" id="login-btn-mobile">Login</a>

      <a href="#" id="invite-btn-mobile">Invite a Friend</a>

      <a href="#" id="settings-mobile">Settings</a>

      <a href="#" id="share-button-mobile">Share</a>

      <a href="#" id="leaderboard-toggle-mobile">Leaderboard</a>

    </nav>

    <div id="pops-remaining"><span id="pop-count">Pops Remaining: 5</span></div>

    <div id="keep-count"><span id="keep-count-text">Keeps Remaining: 1</span></div>

    <div id="reset-timer">Next Reset: <span id="timer">00:03:00</span></div>

    <!-- Waitlist Status -->

    <div id="waitlist-status"></div>

  </header>

  <!-- Global Ticker -->

  <div id="ticker">

    <div id="ticker-content"></div>

  </div>

  <!-- Leaderboard -->

  <div id="leaderboard-dropdown" style="display:none; position:absolute; top:50px; right:20px; background:#fff; padding:10px; border:1px solid #ccc; z-index:1000;">

    <h3>Leaderboard</h3>

    <ul id="full-hearts-leaderboard"></ul>

    <ul id="broken-hearts-leaderboard"></ul>

    <button id="close-leaderboard">Close</button>

  </div>

  <!-- Navigation Buttons -->

  <nav id="nav-buttons">

    <button onclick="changeRoom('up')">Previous Room</button>

    <span id="room-indicator">Balloon Room 1 of 10</span>

    <button onclick="changeRoom('down')">Next Room</button>

  </nav>

  <main>

    <div id="search-container" style="text-align:center; margin:10px 0;">

      <input type="text" id="search-coords" placeholder="e.g., 1,2" />

      <button id="search-btn">Search</button>

      <button id="rent-btn">Book a spot</button>

    </div>

    <div id="balloon-container">

      <div id="grid-container"></div>

    </div>

  </main>

  <div id="bottom-banner">Enjoy finding your match!</div>

  <footer>&copy; 2025 Pop Balloons or Find Love. All rights reserved.</footer>

  

  <!-- Profile Modal -->

  <div id="profile-modal" class="modal">

    <div class="modal-content">

      <span class="close">&times;</span>

      <h2 id="profile-name"></h2>

      <p id="profile-handle"></p>

      <button id="pop-balloon">Pop Balloon</button>

      <button id="keep-balloon">Keep Balloon</button>

    </div>

  </div>

  <!-- Keep Modal -->

  <div id="keep-modal" class="modal">

    <div class="modal-content">

      <span class="close" id="keep-close">&times;</span>

      <h2>Balloon Kept!</h2>

      <p>Here is the profile of the player you kept:</p>

      <img id="kept-profile-pic" src="" alt="Profile Picture" style="max-width:100px; border-radius:50%;"/><br/>

      <div id="social-links">

        <p>Your match: <a href="" id="kept-handle-link" target="_blank"></a></p>

        <button id="show-more-btn">More potential matches (+"0")</button>

        <div id="more-matches" style="display:none;"></div>

      </div>

    </div>

  </div>

  <!-- Settings Modal -->

  <div id="settings-modal" class="modal">

    <div id="settings-content">

      <span id="settings-close" class="close">&times;</span>

      <h2>Settings</h2>

      <label>

        <input type="checkbox" id="sound-toggle"> Sound On/Off

      </label>

    </div>

  </div>

  <!-- Sign-Up Modal -->

  <div id="signup-modal" class="modal">

    <div id="signup-content">

      <span class="close" id="signup-close">&times;</span>

      <h2>Sign Up</h2>

      <form id="signup-form">

        <input type="text" id="nickname" placeholder="Nickname" required /><br />

        <select id="gender" required>

          <option value="">Select Gender</option>

          <option value="male">Male</option>

          <option value="female">Female</option>

        </select><br />

        <select id="platform" required>

          <option value="Telegram">Telegram</option>

          <option value="X">X</option>

          <option value="WhatsApp">WhatsApp</option>

        </select><br />

        <input type="text" id="social-handle" placeholder="Social Media Handle" required /><br />

        <input type="number" id="age" placeholder="Age" required /><br />

        <!-- URL input or file upload for profile picture -->

        <input type="url" id="profile-pic" placeholder="Profile Picture URL (optional)" /><br />

        <label for="profile-pic-upload">Or Upload a Profile Picture:</label><br />

        <input type="file" id="profile-pic-upload" accept="image/*" /><br />

        <label for="pref-loveLanguages">Love Languages (choose at least one):</label><br />

        <select id="pref-loveLanguages" multiple required>

          <option value="Words of Affirmation">Words of Affirmation</option>

          <option value="Quality Time">Quality Time</option>

          <option value="Receiving Gifts">Receiving Gifts</option>

          <option value="Acts of Service">Acts of Service</option>

          <option value="Physical Touch">Physical Touch</option>

        </select><br />

        <label for="pref-hobbies">Hobbies (choose at least one):</label><br />

        <select id="pref-hobbies" multiple required>

          <option value="Reading">Reading</option>

          <option value="Traveling">Traveling</option>

          <option value="Cooking">Cooking</option>

          <option value="Gaming">Gaming</option>

          <option value="Sports">Sports</option>

          <option value="Hiking">Hiking</option>

        </select><br />

        <label for="pref-dealBreakers">Deal Breakers (choose at least one):</label><br />

        <select id="pref-dealBreakers" multiple required>

          <option value="Smoking">Smoking</option>

          <option value="Cheating">Cheating</option>

          <option value="Dishonesty">Dishonesty</option>

          <option value="Inflexibility">Inflexibility</option>

          <option value="Negativity">Negativity</option>

        </select><br />

        <label class="terms">

          <input type="checkbox" id="terms-confirm" required>

          I confirm that I am 18 years or older and agree to the <a href="#" target="_blank">Terms of Use</a> and <a href="#" target="_blank">Privacy Policy</a>.

        </label>

        <button type="submit">Sign Up</button>

      </form>

    </div>

  </div>

  <!-- Tutorial Modal -->

  <div id="tutorial-modal" class="modal">

    <div class="modal-content">

      <span class="close" id="tutorial-close">&times;</span>

      <h2>Tutorial / Onboarding</h2>

      <p>Welcome to Pop Balloons or Find Love! Here are some new features to help you get started:</p>

      <ul>

        <li><strong>Balloon Spots:</strong> Book your own spot in a room. The first room is premium-priced, with fees decreasing in each subsequent room.</li>

        <li><strong>Subscriptions:</strong> Enjoy a free 3-day trial or choose between Basic ($4.99/month) and Premium ($9.99/month) subscriptions for extra benefits.</li>

        <li><strong>Ad Options:</strong> Watch rewarded ads for extra pops/keeps – or choose the one–time Ad-Free option to remove ads permanently.</li>

        <li><strong>Invite a Friend:</strong> Invite your friends to join. If they sign up using your invite link, both of you earn extra pops and keeps!</li>

      </ul>

      <p>Click the "×" to close this tutorial.</p>

    </div>

  </div>

  <!-- Share Modal -->

  <div id="share-modal" class="modal">

    <div id="share-content" class="modal-content">

      <span class="close" id="share-close">&times;</span>

      <h2>Share This Game</h2>

      <p>Spread the word about Pop Balloons or Find Love!</p>

      <div>

        <a href="#" id="share-x" target="_blank">X</a>

        <a href="#" id="share-telegram" target="_blank">Telegram</a>

        <a href="#" id="share-facebook" target="_blank">Facebook</a>

        <a href="#" id="share-whatsapp" target="_blank">WhatsApp</a>

        <a href="javascript:void(0)" id="share-instagram">Instagram (Copy Link)</a>

      </div>

    </div>

    <audio id="pop-sound" src="pop.mp3"></audio>

  </div>

  <script>

    

    // ========= Global Variables and Waitlist Logic =========

let currentPlayerData = null;

let hasSignedUp = false;

let waitlistMale = [];

let waitlistFemale = [];

let paidWaitlistMale = [];

let paidWaitlistFemale = [];

let signedUpUsers = [];

let globalPops = 0;

let globalKeeps = 0;

let waitlistCounter = 1;

let simulatedUsersAdded = false;



// Game session management

let gameSession = {

  popsInSession: 0,

  keepsInSession: 0,

  lastAction: null, // 'pop' or 'keep'

  reset: function() {

    this.popsInSession = 0;

    this.keepsInSession = 0;

    this.lastAction = null;

  }

};



// Added new variables...

let malePops = 0;

let femalePops = 0;

let sponsoredPops = 0;

let lockedGender = null; // Track the locked-in gender

let allowSponsoredPops = false; // Control whether sponsored pops and keeps are allowed



// Grid settings: 3 columns x 40 rows = 120 cells (10 rooms of 3x4)

const gridWidth = 3;

const gridHeight = 40;

const cellSize = 150;

const balloonSize = 50;



const roomRows = 4;

const totalRooms = gridHeight / roomRows; // exactly 10 rooms

let currentRoom = 1;



// Booking settings – 5-minute duration.

const rentalDuration = 5 * 60 * 1000;

const maxNickLength = Math.floor(cellSize / 10);



// Colors for balloon states.

const availableColor = "radial-gradient(circle at center, #d1f7d1, lightgreen)";

const maleColor = "radial-gradient(circle at center, #add8e6, #0000ff)";

const femaleColor = "radial-gradient(circle at center, #ffb6c1, #ff69b4)";

const customTickerText = "Welcome to Pop Balloons or Find Love! | Click a balloon to pop or keep it, sign up, book a spot, and invite friends to earn rewards!";



// Auto-login on page load if a user has been saved in localStorage.

if (localStorage.getItem("playerData")) {

  currentPlayerData = JSON.parse(localStorage.getItem("playerData"));

  alert("Welcome back, " + currentPlayerData.nickname + "!");

}



function getBookingFee(x, y) {

  const room = Math.floor(y / roomRows) + 1;

  return 55 - room * 5;

}



/* Payment Processing Stub */

function processPayment(amount, description, callback) {

  console.log(`Processing payment: $${amount} for ${description}`);

  setTimeout(() => { callback(true); }, 1000);

}



// Simulated users – note: only the first simulated user is "sponsored".

const simulatedUsers = [

  { nickname: "JohnDoe", gender: "sponsored", platform: "Telegram", socialHandle: "@JohnDoe",

    age: 30, profilePic: "https://via.placeholder.com/100?text=JohnDoe",

    isRealSignup: true, matchedWith: [], fullHearts: 0, brokenHearts: 0, isSimulated: true,

    loveLanguages: ["Quality Time"], hobbies: ["Reading", "Gaming"], dealBreakers: ["Dishonesty"] },

  { nickname: "JaneDoe", gender: "female", platform: "X", socialHandle: "@JaneDoe",

    age: 28, profilePic: "https://via.placeholder.com/100?text=JaneDoe",

    isRealSignup: true, matchedWith: [], fullHearts: 0, brokenHearts: 0, isSimulated: true,

    loveLanguages: ["Receiving Gifts"], hobbies: ["Traveling", "Cooking"], dealBreakers: ["Cheating"] },

  { nickname: "Alice", gender: "female", platform: "WhatsApp", socialHandle: "@Alice",

    age: 26, profilePic: "https://via.placeholder.com/100?text=Alice",

    isRealSignup: true, matchedWith: [], fullHearts: 0, brokenHearts: 0, isSimulated: true,

    loveLanguages: ["Acts of Service"], hobbies: ["Hiking"], dealBreakers: ["Smoking"] },

  { nickname: "Bob", gender: "male", platform: "Telegram", socialHandle: "@Bob",

    age: 32, profilePic: "https://via.placeholder.com/100?text=Bob",

    isRealSignup: true, matchedWith: [], fullHearts: 0, brokenHearts: 0, isSimulated: true,

    loveLanguages: ["Physical Touch"], hobbies: ["Sports"], dealBreakers: ["Inflexibility"] },

  { nickname: "Katrina", gender: "female", platform: "Telegram", socialHandle: "@Kat",

    age: 25, profilePic: "https://via.placeholder.com/100?text=Bob",

    isRealSignup: true, matchedWith: [], fullHearts: 0, brokenHearts: 0, isSimulated: true,

    loveLanguages: ["Physical Touch"], hobbies: ["Sports"], dealBreakers: ["Cheating"] },

  { nickname: "Kiera", gender: "female", platform: "Telegram", socialHandle: "@Kie",

    age: 21, profilePic: "https://via.placeholder.com/100?text=Kie",

    isRealSignup: true, matchedWith: [], fullHearts: 0, brokenHearts: 0, isSimulated: true,

    loveLanguages: ["Receiving Gifts"], hobbies: ["Sports"], dealBreakers: ["Cheating"] }

];



/* ========= DOM Element References ========= */

const balloonContainer = document.getElementById("balloon-container");

const gridContainer = document.getElementById("grid-container");

let gridCells = [];

const modal = document.getElementById("profile-modal");

const closeButtons = document.querySelectorAll(".close");

const profileName = document.getElementById("profile-name");

const profileHandle = document.getElementById("profile-handle");

const popBalloonButton = document.getElementById("pop-balloon");

const keepBalloonButton = document.getElementById("keep-balloon");



const settingsButton = document.getElementById("settings");



const settingsModal = document.getElementById("settings-modal");

const settingsClose = document.getElementById("settings-close");

const soundToggle = document.getElementById("sound-toggle");

const resetTimerDisplay = document.getElementById("timer");

const popSound = document.getElementById("pop-sound");

const popCountDisplay = document.getElementById("pop-count");

const keepCountDisplay = document.getElementById("keep-count-text");

const tickerContent = document.getElementById("ticker-content");



const fullHeartsLeaderboard = document.getElementById("full-hearts-leaderboard");

const brokenHeartsLeaderboard = document.getElementById("broken-hearts-leaderboard");

const leaderboardToggle = document.getElementById("leaderboard-toggle");

const leaderboardDropdown = document.getElementById("leaderboard-dropdown");

const closeLeaderboard = document.getElementById("close-leaderboard");



const signupModal = document.getElementById("signup-modal");

const signupClose = document.getElementById("signup-close");

const signupForm = document.getElementById("signup-form");



const shareButton = document.getElementById("share-button");

const shareModal = document.getElementById("share-modal");

const shareClose = document.getElementById("share-close");

const shareX = document.getElementById("share-x");

const shareTelegram = document.getElementById("share-telegram");

const shareFacebook = document.getElementById("share-facebook");

const shareWhatsapp = document.getElementById("share-whatsapp");

const shareInstagram = document.getElementById("share-instagram");



const subscribeBtn = document.getElementById("subscribe-btn");

const coffeeBundleBtn = document.getElementById("coffee-bundle-btn");

const watchAdBtn = document.getElementById("watch-ad-btn");

const removeAdsBtn = document.getElementById("remove-ads-btn");



const searchInput = document.getElementById("search-coords");

const searchBtn = document.getElementById("search-btn");

const rentBtn = document.getElementById("rent-btn");



const roomIndicator = document.getElementById("room-indicator");



const loginBtn = document.getElementById("login-btn");



const tutorialBtn = document.getElementById("tutorial");



const inviteBtn = document.getElementById("invite-btn");



const shareUrl = encodeURIComponent(window.location.href);

const shareText = encodeURIComponent("Check out Pop Balloons or Find Love!");

shareX.href = `https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}`;

shareTelegram.href = `https://t.me/share/url?url=${shareUrl}&text=${shareText}`;

shareFacebook.href = `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`;

shareWhatsapp.href = `https://api.whatsapp.com/send?text=${shareText}%20${shareUrl}`;

shareInstagram.addEventListener("click", () => {

  navigator.clipboard.writeText(window.location.href)

    .then(() => alert("Link copied to clipboard!"))

    .catch(() => alert("Failed to copy link."));

});



/* ========= Balloon Data Structure ========= */

const balloons = Array.from({ length: gridWidth }, (_, x) =>

  Array.from({ length: gridHeight }, (_, y) => ({

    color: null, popped: false, kept: false, user: null,

    expiresAt: Date.now() + 3 * 60 * 1000,

    paidUntil: null, offsetX: 0, offsetY: 0,

    velX: (Math.random() - 0.5) * 0.2,

    velY: (Math.random() - 0.5) * 0.2,

    initialX: x * cellSize + (cellSize - balloonSize) / 2,

    initialY: y * cellSize + (cellSize - balloonSize) / 2,

    rentedBy: null, rentedUntil: 0,

    element: null

  }))

);



/* ========= Room & Grid Functions ========= */

function initRoomGrid() {

  const roomStart = (currentRoom - 1) * roomRows;

  const rowsInRoom = (currentRoom < totalRooms) ? roomRows : (gridHeight - roomStart);

  gridContainer.style.width = `${cellSize * gridWidth}px`;

  gridContainer.style.height = `${cellSize * rowsInRoom}px`;

  gridContainer.innerHTML = "";

  gridCells = [];

  for (let x = 0; x < gridWidth; x++) {

    gridCells[x] = [];

    for (let y = roomStart; y < roomStart + rowsInRoom; y++) {

      const cell = document.createElement("div");

      cell.className = "grid-cell";

      cell.style.left = `${x * cellSize}px`;

      cell.style.top = `${(y - roomStart) * cellSize}px`;

      cell.setAttribute("data-x", x);

      cell.setAttribute("data-y", y);

      const label = document.createElement("div");

      label.className = "cell-label";

      label.textContent = `(${x},${y})`;

      cell.appendChild(label);

      gridContainer.appendChild(cell);

      gridCells[x][y] = cell;

    }

  }

}



/* ========= Balloon Rendering ========= */

function renderBalloons() {

  const existingBalloons = document.querySelectorAll(".balloon");

  existingBalloons.forEach(el => el.remove());



  const roomStart = (currentRoom - 1) * roomRows;

  const rowsInRoom = (currentRoom < totalRooms) ? roomRows : (gridHeight - roomStart);



  for (let x = 0; x < gridWidth; x++) {

    for (let y = roomStart; y < roomStart + rowsInRoom; y++) {

      const balloon = balloons[x][y];

      if (balloon.paidUntil ? balloon.paidUntil > Date.now() : balloon.expiresAt > Date.now()) {

        const balloonElement = document.createElement("div");

        balloonElement.className = "balloon";

        // Apply sponsored styling only if user.gender equals "sponsored"

        if (balloon.user && balloon.user.gender === "sponsored") {

          balloonElement.classList.add("sponsored-balloon");

        }

        balloonElement.style.left = `${balloon.initialX + balloon.offsetX}px`;

        balloonElement.style.top = `${(balloon.initialY - roomStart * cellSize) + balloon.offsetY}px`;

        if (!balloon.popped) {

          if (balloon.user) {

            // For non-sponsored simulated players and real users, use appropriate color.

            balloonElement.style.background = (balloon.user.gender === "male") ? maleColor : (balloon.user.gender === "female") ? femaleColor : availableColor;

          } else { 

            // Available balloon uses availableColor (green) so it is visible.

            balloonElement.style.background = availableColor; 

          }

        } else {

          balloonElement.style.background = "gray";

          balloonElement.innerHTML = `<span class="popped-emoji">??</span>`;

        }

        if (!balloon.popped) {

          if (balloon.kept) {

            const keptSpan = document.createElement("span");

            keptSpan.className = "kept-icon";

            keptSpan.textContent = "??";

            balloonElement.appendChild(keptSpan);

          }

          if (!balloon.user) {

            const availableSpan = document.createElement("span");

            availableSpan.className = "available-icon";

            availableSpan.textContent = "??";

            balloonElement.appendChild(availableSpan);

          }

          const stringElement = document.createElement("div");

          stringElement.className = "balloon-string";

          balloonElement.appendChild(stringElement);

          if (balloon.user) {

            const genderIndicator = document.createElement("div");

            genderIndicator.className = "gender-indicator";

            genderIndicator.textContent = balloon.user.isSimulated 

              ? (balloon.user.gender === "sponsored" ? "Sponsored" : (balloon.user.gender === "male" ? "M" : "F"))

              : (balloon.user.gender === "male" ? "M" : (balloon.user.gender === "female" ? "F" : ""));

            balloonElement.appendChild(genderIndicator);

          }

        }

        // Create and assign ticker tape below each balloon with a random duration between 10s and 15s.

        const tickerTape = document.createElement("div");

        tickerTape.className = "balloon-ticker";

        const tickerSpan = document.createElement("span");

        let text;

        if (balloon.user) {

          const waitlistNumberText = balloon.user.waitlistNumber ? "Spot #" + balloon.user.waitlistNumber + " | " : "";

          const name = balloon.user.nickname || "";

          const age = balloon.user.age || "N/A";

          const hobbies = balloon.user.hobbies ? balloon.user.hobbies.join(", ") : "N/A";

          const loveLanguages = balloon.user.loveLanguages ? balloon.user.loveLanguages.join(", ") : "N/A";

          const dealBreakers = balloon.user.dealBreakers ? balloon.user.dealBreakers.join(", ") : "N/A";

          let status = "Active";

          if (balloon.popped) { status = "Popped"; }

          else if (balloon.kept) { status = "Kept"; }

          text = waitlistNumberText + `${name} | Age: ${age} | Hobbies: ${hobbies} | Love: ${loveLanguages} | Deal: ${dealBreakers} | ${status}`;

        } else { 

          text = "Available! Click to sign up and join the game!"; 

        }

        tickerSpan.innerHTML = text + "    " + text;

        var tickerDuration = (10 + Math.random() * 5).toFixed(2) + "s";

        tickerSpan.style.animation = "tickerTapeAnim " + tickerDuration + " linear infinite";

        tickerTape.appendChild(tickerSpan);

        balloonElement.appendChild(tickerTape);



        balloonElement.dataset.handle = balloon.user ? balloon.user.nickname : "Sign Up / Login";

        balloonElement.addEventListener("click", () => handleBalloonClick(x, y));

        gridContainer.appendChild(balloonElement);

        balloon.element = balloonElement;

      }

    }

  }

  updateBookingLabels();

}



function updateBalloonPositions() {

  const roomStart = (currentRoom - 1) * roomRows;

  for (let x = 0; x < gridWidth; x++) {

    for (let y = roomStart; y < roomStart + roomRows; y++) {

      const balloon = balloons[x][y];

      if (balloon && balloon.element) {

        balloon.element.style.left = `${balloon.initialX + balloon.offsetX}px`;

        balloon.element.style.top = `${(balloon.initialY - roomStart * cellSize) + balloon.offsetY}px`;

      }

    }

  }

}



function simulateBalloons() {

  const now = Date.now();

  const maxOffset = 10;

  for (let x = 0; x < gridWidth; x++) {

    for (let y = 0; y < gridHeight; y++) {

      let bubble = balloons[x][y];

      if (bubble.paidUntil ? bubble.paidUntil <= now : bubble.expiresAt <= now) continue;

      bubble.offsetX += bubble.velX;

      bubble.offsetY += bubble.velY;

      if (bubble.offsetX > maxOffset || bubble.offsetX < -maxOffset) {

        bubble.velX = -bubble.velX;

        bubble.offsetX = Math.max(Math.min(bubble.offsetX, maxOffset), -maxOffset);

      }

      if (bubble.offsetY > maxOffset || bubble.offsetY < -maxOffset) {

        bubble.velY = -bubble.velY;

        bubble.offsetY = Math.max(Math.min(bubble.offsetY, maxOffset), -maxOffset);

      }

    }

  }

  let bubbleList = [];

  for (let x = 0; x < gridWidth; x++) {

    for (let y = 0; y < gridHeight; y++) {

      let bubble = balloons[x][y];

      if (bubble.paidUntil ? bubble.paidUntil <= now : bubble.expiresAt <= now) continue;

      bubble.centerX = bubble.initialX + balloonSize/2 + bubble.offsetX;

      bubble.centerY = bubble.initialY + balloonSize/2 + bubble.offsetY;

      bubbleList.push(bubble);

    }

  }

  for (let i = 0; i < bubbleList.length; i++) {

    for (let j = i + 1; j < bubbleList.length; j++) {

      let b1 = bubbleList[i], b2 = bubbleList[j];

      let dx = b2.centerX - b1.centerX;

      let dy = b2.centerY - b1.centerY;

      let dist = Math.sqrt(dx*dx + dy*dy);

      let minDist = balloonSize;

      if (dist < minDist && dist > 0) {

        let overlap = minDist - dist;

        let pushX = (dx / dist) * (overlap / 2);

        let pushY = (dy / dist) * (overlap / 2);

        b1.offsetX -= pushX;

        b1.offsetY -= pushY;

        b2.offsetX += pushX;

        b2.offsetY += pushY;

        b1.velX = -b1.velX;

        b1.velY = -b1.velY;

        b2.velX = -b2.velX;

        b2.velY = -b2.velY;

      }

    }

  }

  updateBalloonPositions();

  requestAnimationFrame(simulateBalloons);

}



function notifyPlayerTurn(player, room, x, y) {

  alert(`Notification to ${player.socialHandle}: It's your turn! You've been assigned to Balloon Room ${room} at spot (${x},${y}).`);

}



function assignBalloonSpots() {

  assignPaidPlayers();

  let freeCells = [];

  for (let x = 0; x < gridWidth; x++) {

    for (let y = 0; y < gridHeight; y++) {

      if (!balloons[x][y].user) { freeCells.push({ x, y }); }

    }

  }

  let combinedWaitlist = waitlistMale.concat(waitlistFemale);

  for (let i = 0; i < combinedWaitlist.length && i < freeCells.length; i++) {

    let player = combinedWaitlist[i];

    if (!player.waitlistNumber) { player.waitlistNumber = waitlistCounter++; }

    let { x, y } = freeCells[i];

    balloons[x][y].user = player;

    if (player.gender === "male") { waitlistMale.shift(); } else { waitlistFemale.shift(); }

    if (currentPlayerData && player.socialHandle === currentPlayerData.socialHandle) {

      const roomAssigned = Math.floor(y / roomRows) + 1;

      notifyPlayerTurn(player, roomAssigned, x, y);

    }

  }

  initRoomGrid();

  renderBalloons();

  updateTicker();

  updateWaitlistStatus();

}



function updateWaitlistStatus() {

  const waitlistCount = waitlistMale.length + waitlistFemale.length;

  const ws = document.getElementById("waitlist-status");

  if(ws) { ws.textContent = `Waitlist: ${waitlistCount} players`; }

}



function assignPaidPlayers() {

  if (paidWaitlistMale.length > 0 && waitlistFemale.length >= 2) {

    for (let candidate of paidWaitlistMale.slice()) {

      for (let x = 0; x < gridWidth; x++) {

        for (let y = 0; y < gridHeight; y++) {

          const cell = balloons[x][y];

          if (!cell.user) {

            candidate.waitlistNumber = waitlistCounter++;

            cell.user = candidate;

            paidWaitlistMale = paidWaitlistMale.filter(c => c !== candidate);

            x = gridWidth; y = gridHeight;

            break;

          }

        }

      }

    }

  }

  if (paidWaitlistFemale.length > 0 && waitlistMale.length >= 2) {

    for (let candidate of paidWaitlistFemale.slice()) {

      for (let x = 0; x < gridWidth; x++) {

        for (let y = 0; y < gridHeight; y++) {

          const cell = balloons[x][y];

          if (!cell.user) {

            candidate.waitlistNumber = waitlistCounter++;

            cell.user = candidate;

            paidWaitlistFemale = paidWaitlistFemale.filter(c => c !== candidate);

            x = gridWidth; y = gridHeight;

            break;

          }

        }

      }

    }

  }

}



function updateTicker() {

  const tickerText = customTickerText;

  if(tickerContent) {

    tickerContent.innerHTML = tickerText + "    " + tickerText;

    tickerContent.style.animation = 'none';

    setTimeout(() => {

      tickerContent.style.animation = 'tickerTapeAnim 12s linear infinite';

    }, 10);

  }

}



function updateLeaderboard() {

  const mergedUsers = [];

  if (currentPlayerData) { mergedUsers.push(currentPlayerData); }

  const sortedFullHearts = mergedUsers.slice().sort((a, b) => (b.fullHearts || 0) - (a.fullHearts || 0));

  if(fullHeartsLeaderboard) {

    fullHeartsLeaderboard.innerHTML = sortedFullHearts.map((user, index) => `<li><a href="#" target="_blank">${index + 1}. ${user.nickname} - ${user.fullHearts || 0}</a></li>`).join("");

  }

  const sortedBrokenHearts = mergedUsers.slice().sort((a, b) => (b.brokenHearts || 0) - (a.brokenHearts || 0));

  if(brokenHeartsLeaderboard) {

    brokenHeartsLeaderboard.innerHTML = sortedBrokenHearts.map((user, index) => `<li><a href="#" target="_blank">${index + 1}. ${user.nickname} - ${user.brokenHearts || 0}</a></li>`).join("");

  }

}



function getSocialMediaLink(user) {

  if(user.isSimulated) {

    return "https://www.example.com/" + encodeURIComponent(user.nickname);

  } else {

    let handle = user.socialHandle;

    if(handle.startsWith("@")) { handle = handle.slice(1); }

    if(user.platform === "Telegram") { return "https://t.me/" + handle; }

    else if(user.platform === "X") { return "https://twitter.com/" + handle; }

    else if(user.platform === "WhatsApp") { return "https://wa.me/" + handle; }

    else { return "#"; }

  }

}



function showKeepModal(keptUser) {
  const keepModal = document.getElementById("keep-modal");
  const keptPicImg = document.getElementById("kept-profile-pic");
  const keptHandleLink = document.getElementById("kept-handle-link");
  const showMoreBtn = document.getElementById("show-more-btn");
  const moreMatchesDiv = document.getElementById("more-matches");
  const keepClose = document.getElementById("keep-close");
  
  // Set up the close button
  keepClose.onclick = function() {
    keepModal.style.display = "none";
  };

  // Set profile info
  keptPicImg.src = keptUser.profilePic || "https://via.placeholder.com/100?text=No+Image";
  keptPicImg.alt = keptUser.nickname + "'s Profile Picture";
  keptHandleLink.href = getSocialMediaLink(keptUser);
  keptHandleLink.textContent = keptUser.socialHandle;

  // Find potential matches
  let potentialMatches = [];
  for (let x = 0; x < gridWidth; x++) {
    for (let y = 0; y < gridHeight; y++) {
      let balloon = balloons[x][y];
      if (balloon.user && !balloon.popped && balloon.user.gender === keptUser.gender) {
        if (!(balloon.user.nickname === keptUser.nickname && balloon.user.socialHandle === keptUser.socialHandle)) {
          potentialMatches.push(balloon.user);
        }
      }
    }
  }

  // Set up the "More potential matches" button
  showMoreBtn.textContent = `More potential matches (+${potentialMatches.length})`;
  moreMatchesDiv.innerHTML = "";
  
  showMoreBtn.onclick = function() {
    if (moreMatchesDiv.style.display === "none" || moreMatchesDiv.style.display === "") {
      // Clear previous matches
      moreMatchesDiv.innerHTML = "";
      
      // Add each potential match as a link
      potentialMatches.forEach(user => {
        const matchDiv = document.createElement("div");
        const a = document.createElement("a");
        a.href = getSocialMediaLink(user);
        a.target = "_blank";
        a.textContent = `${user.nickname} (${user.platform}: ${user.socialHandle})`;
        matchDiv.appendChild(a);
        
        // Add user details
        const details = document.createElement("p");
        details.textContent = `Age: ${user.age}, Hobbies: ${user.hobbies.join(", ")}, Love Languages: ${user.loveLanguages.join(", ")}`;
        matchDiv.appendChild(details);
        
        moreMatchesDiv.appendChild(matchDiv);
      });
      
      moreMatchesDiv.style.display = "block";
      showMoreBtn.textContent = "Hide potential matches";
    } else {
      moreMatchesDiv.style.display = "none";
      showMoreBtn.textContent = `More potential matches (+${potentialMatches.length})`;
    }
  };

  // Show the modal
  keepModal.style.display = "block";
}

function handlePopBalloon(balloon) {

  if (gameSession.lastAction === 'keep') {

    alert("You can only keep one balloon per session. Please start a new session to pop more balloons.");

    return false;

  }



  if (lockedGender && balloon.user.gender !== lockedGender) {

    alert(`You are locked into ${lockedGender} balloons. You cannot pop a ${balloon.user.gender} balloon.`);

    return false;

  }



  if (balloon.user.gender === "sponsored" && !allowSponsoredPops) {

    alert("Sponsored balloons cannot be popped at the moment.");

    return false;

  }



  if (popsRemaining > 0) {

    balloon.popped = true;

    balloon.user.brokenHearts = (balloon.user.brokenHearts || 0) + 1;

    popsRemaining--;

    gameSession.popsInSession++;

    gameSession.lastAction = 'pop';



    // Increment the appropriate gender counter

    if (balloon.user.gender === "male") {

      malePops++;

    } else if (balloon.user.gender === "female") {

      femalePops++;

    } else if (balloon.user.gender === "sponsored") {

      sponsoredPops++;

    }



    // Lock the gender if not already locked

    if (!lockedGender) {

      lockedGender = balloon.user.gender;

      alert(`You are now locked into ${lockedGender} balloons.`);

    }



    popCountDisplay.textContent = `Pops Remaining: ${popsRemaining}`;

    if (soundToggle.checked) popSound.play();

    renderBalloons();

    updateLeaderboard();

    return true;

  } else {

    alert("No pops remaining! Buy more to continue.");

    return false;

  }

}



// ========= Balloon Click Handler =========

function handleBalloonClick(x, y) {

  const balloon = balloons[x][y];



  // Handle sponsored balloons (ads)

  if (balloon.user && balloon.user.isSimulated && balloon.user.gender === "sponsored") {

    if (!allowSponsoredPops) {

      handleSimulatedAd(balloon); // Only show ads for sponsored balloons

      return;

    }

  }



  // If the balloon is already popped or kept, do nothing

  if (balloon.popped || balloon.kept) {

    return;

  }



  // If the balloon has a user, show the profile modal

  if (balloon.user) {

    // Set the profile name and handle in the modal

    profileName.textContent = balloon.user.nickname;

    if (currentPlayerData && balloon.user.matchedWith && balloon.user.matchedWith.includes(currentPlayerData.nickname)) {

      profileHandle.textContent = `${balloon.user.platform}: ${balloon.user.socialHandle}`;

    } else {

      profileHandle.textContent = "";

    }



    // Show the modal

    modal.style.display = "block";



    // Set up the keep balloon button's onclick handler

    keepBalloonButton.onclick = () => {

      if (handleKeepBalloon(balloon)) {

        modal.style.display = "none"; // Close the modal if the keep operation succeeds

      }

    };



    // Set up the pop balloon button's onclick handler

    popBalloonButton.onclick = () => {

      if (handlePopBalloon(balloon)) {

        modal.style.display = "none"; // Close the modal if the pop operation succeeds

      }

    };

  } else {

    // If the balloon is available, prompt the user to sign up

    let playerData = localStorage.getItem("playerData");

    if (playerData) {

      playerData = JSON.parse(playerData);

      let alreadyHasSpot = false;

      for (let i = 0; i < gridWidth; i++) {

        for (let j = 0; j < gridHeight; j++) {

          let b = balloons[i][j];

          if (b.user && b.user.nickname === playerData.nickname && b.user.socialHandle === playerData.socialHandle) {

            alreadyHasSpot = true;

            break;

          }

        }

        if (alreadyHasSpot) break;

      }

      if (alreadyHasSpot) {

        alert("You already have a balloon spot. Please wait for the next round or pay $1 if you prefer to play again.");

        return;

      }

      if (confirm("You have already signed up. Do you want to log in to claim this spot?")) {

        balloon.user = playerData;

        hasSignedUp = true;

        alert("Logged in successfully!");

        renderBalloons();

        updateTicker();

      }

    } else {

      // If the user is not signed up, show the sign-up modal

      signupModal.style.display = "block";

    }

  }

}



// New function to handle kept balloons

function handleKeepBalloon(balloon) {

  // Check if the user has already performed a keep action in this session

  if (gameSession.lastAction === 'keep') {

    alert("You can only keep one balloon per session. Please start a new session to keep more balloons.");

    return false;

  }



  // Check if the balloon's gender matches the locked gender (if any)

  if (lockedGender && balloon.user.gender !== lockedGender) {

    alert(`You are locked into ${lockedGender} balloons. You cannot keep a ${balloon.user.gender} balloon.`);

    return false;

  }



  // Check if sponsored balloons are allowed to be kept

  if (balloon.user.gender === "sponsored" && !allowSponsoredPops) {

    alert("Sponsored balloons cannot be kept at the moment.");

    return false;

  }



  // Check if the user has any keeps remaining

  if (keepsRemaining <= 0) {

    alert("No keeps remaining!");

    return false;

  }



  // Mark the balloon as kept

  balloon.kept = true;



  // Update the kept user's profile (e.g., increment fullHearts)

  balloon.user.fullHearts = (balloon.user.fullHearts || 0) + 1;


///////////////new placing//////////////////////////////////////////////////////////////////
  // Custom action: Display a custom message

//  alert(`You kept ${balloon.user.nickname}'s balloon!`);
showKeepModal(balloon.user);
//Now needs to be closed. Add closing logic.
///////////////////////////////////////////////////////////////////////////////////////




  // Update matchedWith arrays for both players

  if (currentPlayerData) {

    if (!currentPlayerData.matchedWith) currentPlayerData.matchedWith = [];

    if (!balloon.user.matchedWith) balloon.user.matchedWith = [];

    if (!currentPlayerData.matchedWith.includes(balloon.user.nickname)) {

      currentPlayerData.matchedWith.push(balloon.user.nickname);

    }

    if (!balloon.user.matchedWith.includes(currentPlayerData.nickname)) {

      balloon.user.matchedWith.push(currentPlayerData.nickname);

    }

  }



  // Decrement keeps remaining

  keepsRemaining--;

  globalKeeps++;

  gameSession.keepsInSession++;

  gameSession.lastAction = 'keep';



  // Reset the gender-specific pop counter after keeping a balloon

  if (balloon.user.gender === "male") {

    malePops = 0;

  } else if (balloon.user.gender === "female") {

    femalePops = 0;

  } else if (balloon.user.gender === "sponsored") {

    sponsoredPops = 0;

  }



  // Render updates to the UI

  renderBalloons();

  updateLeaderboard();

  updateTicker();



  // Show the kept user's profile and potential matches

//////////////////old placing///////////////////////////////  showKeepModal(balloon.user);



  console.log(`Keeping a ${balloon.user.gender} balloon. Current pops: male=${malePops}, female=${femalePops}, sponsored=${sponsoredPops}`);

  return true;

}

// ========= Handle Simulated Ad =========

function handleSimulatedAd(balloon) {

  if (!currentPlayerData) {

    alert("Please sign up to watch rewarded ads.");

    return;

  }

  if (currentPlayerData.adFree) {

    alert("You have removed ads.");

    return;

  }

  if (confirm("This is a sponsored ad. Would you like to watch a rewarded video for extra pops/keeps?")) {

    setTimeout(() => {

      popsRemaining += 3;

      keepsRemaining += 1;

      popCountDisplay.textContent = `Pops Remaining: ${popsRemaining}`;

      keepCountDisplay.textContent = `Keeps Remaining: ${keepsRemaining}`;

      alert("Ad watched! You've earned extra pops and keeps.");

    }, 2000);

  }

}



function bookSpot(x, y) {

  if (!currentPlayerData) { alert("Please sign up first."); return; }

  if (!currentPlayerData.isSubscribed) { alert("Booking a spot is available only to paid (subscribed) users."); return; }

  const cell = balloons[x][y];

  if (cell.rentedUntil && cell.rentedUntil > Date.now()) { alert("This balloon spot is already booked."); return; }

  const fee = getBookingFee(x, y);

  if (confirm(`Book balloon spot (${x},${y}) for $${fee} for 5 minutes?`)) {

    processPayment(fee, "Book Balloon Spot", (success) => {

      if(success) {

        let nick = currentPlayerData.nickname;

        if (nick.length > maxNickLength) { nick = nick.substring(0, maxNickLength); }

        cell.rentedBy = nick;

        cell.rentedUntil = Date.now() + rentalDuration;

        alert(`Balloon spot (${x},${y}) booked successfully for 5 minutes at $${fee}.`);

        updateBookingLabels();

      } else {

        alert("Payment failed.");

      }

    });

  }

}



function changeRoom(direction) {

  if (direction === "up" && currentRoom > 1) { currentRoom--; }

  else if (direction === "down" && currentRoom < totalRooms) { currentRoom++; }

  roomIndicator.textContent = `Balloon Room ${currentRoom} of ${totalRooms}`;

  initRoomGrid();

  renderBalloons();

}



let resetTime = Date.now() + 3 * 60 * 1000;

let popsRemaining = 5;

let keepsRemaining = 1;

function updateResetTimer() {

  const now = Date.now();

  const timeLeft = resetTime - now;

  if (timeLeft > 0) {

    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));

    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

    resetTimerDisplay.textContent = `00:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;

  } else {

    resetTimerDisplay.textContent = "00:00:00";

    resetTime = Date.now() + 3 * 60 * 1000;

    resetBalloons();

  }

}



function resetBalloons() {

  for (let x = 0; x < gridWidth; x++) {

    for (let y = 0; y < gridHeight; y++) {

      const balloon = balloons[x][y];

      if (!balloon.paidUntil || balloon.paidUntil <= Date.now()) {

        balloon.user = null;

        balloon.popped = false;

        balloon.kept = false;

        balloon.expiresAt = Date.now() + 3 * 60 * 1000;

        balloon.rentedBy = null;

        balloon.rentedUntil = 0;

        balloon.offsetX = 0;

        balloon.offsetY = 0;

      }

    }

  }

  waitlistMale = waitlistMale.filter(p => !p.isSimulated);

  waitlistFemale = waitlistFemale.filter(p => !p.isSimulated);

  // Re-add simulated users into Room 1 on reset.

  simulatedUsers.forEach(user => {

    if (user.gender === "sponsored" && currentPlayerData && currentPlayerData.adFree) {

      waitlistMale.push(user);

      return;

    }

    let assigned = false;

    for (let x = 0; x < gridWidth; x++) {

      for (let y = 0; y < roomRows; y++) {

        if (!balloons[x][y].user) {

          balloons[x][y].user = user;

          assigned = true;

          break;

        }

      }

      if (assigned) break;

    }

    if (!assigned) {

      if (user.gender === "male") { waitlistMale.push(user); }

      else { waitlistFemale.push(user); }

    }

  });

  initRoomGrid();

  renderBalloons();

  updateTicker();

  updateWaitlistStatus();

  gameSession.reset(); // Reset the game session

}



const hamburgerBtn = document.getElementById("hamburger-btn");

const mobileNav = document.getElementById("mobile-nav");

hamburgerBtn.addEventListener("click", () => {

  mobileNav.classList.toggle("active");

});



document.querySelectorAll('[id$="-mobile"]').forEach(item => {

  const handler = () => {

    const desktopId = item.id.slice(0, -7);

    const desktopElement = document.getElementById(desktopId);

    if (desktopElement) {

      desktopElement.click();

    }

    mobileNav.classList.remove("active");

  };

  item.addEventListener("click", handler);

  item.addEventListener("touchstart", handler);

});



settingsClose.addEventListener("click", () => { settingsModal.style.display = "none"; });

closeButtons.forEach(button => {

  button.addEventListener("click", () => {

    modal.style.display = "none";

    signupModal.style.display = "none";

    shareModal.style.display = "none";

  });

});

settingsButton.addEventListener("click", () => { settingsModal.style.display = "block"; });



document.getElementById("buy-pops").addEventListener("click", () => {

  const pops = prompt("How many pops would you like to buy? ($1 per pop)");

  if (pops && !isNaN(pops)) {

    processPayment(parseInt(pops), "Buy Pops", (success) => {

      if(success) {

        popsRemaining += parseInt(pops);

        popCountDisplay.textContent = `Pops Remaining: ${popsRemaining}`;

        alert(`You bought ${pops} pops!`);

      } else {

        alert("Payment failed.");

      }

    });

  }

});



document.getElementById("buy-keeps").addEventListener("click", () => {

  const keeps = prompt("How many keeps would you like to buy? ($1 per keep)");

  if (keeps && !isNaN(keeps)) {

    processPayment(parseInt(keeps), "Buy Keeps", (success) => {

      if(success) {

        keepsRemaining += parseInt(keeps);

        keepCountDisplay.textContent = `Keeps Remaining: ${keeps}`;

        alert(`You bought ${keeps} keeps!`);

      } else {

        alert("Payment failed.");

      }

    });

  }

});



tutorialBtn.addEventListener("click", () => { document.getElementById("tutorial-modal").style.display = "block"; });

document.getElementById("tutorial-close").addEventListener("click", () => { document.getElementById("tutorial-modal").style.display = "none"; });



shareButton.addEventListener("click", () => {

  shareModal.style.display = "block";

});



leaderboardToggle.addEventListener("click", () => {

  if (leaderboardDropdown.style.display === "block") {

    leaderboardDropdown.style.display = "none";

  } else {

    updateLeaderboard();

    leaderboardDropdown.style.display = "block";

  }

});



document.getElementById("close-leaderboard").addEventListener("click", () => {

  leaderboardDropdown.style.display = "none";

});



loginBtn.addEventListener("click", () => {

  let social = prompt("Enter your social media platform (Telegram, X, WhatsApp):");

  let handle = prompt("Enter your social media handle (include @ if desired):");

  let foundUser = signedUpUsers.find(u => u.socialHandle === handle);

  if (foundUser) {

    currentPlayerData = foundUser;

    localStorage.setItem("playerData", JSON.stringify(foundUser));

    alert("Logged in successfully!");

  } else {

    alert("User not found. Please sign up.");

  }

});



inviteBtn.addEventListener("click", () => {

  if (!currentPlayerData) { 

    alert("Please sign up or log in to invite a friend."); 

    return; 

  }

  let inviteLink = window.location.href.split('?')[0] + "?ref=" + encodeURIComponent(currentPlayerData.socialHandle);

  navigator.clipboard.writeText(inviteLink)

    .then(() => alert("Invitation link copied to clipboard!"))

    .catch(() => alert("Failed to copy invitation link."));

});



signupClose.addEventListener("click", () => { signupModal.style.display = "none"; });



signupForm.addEventListener("submit", (e) => {

  e.preventDefault();

  const nickname = document.getElementById("nickname").value.trim();

  const gender = document.getElementById("gender").value;

  const platform = document.getElementById("platform").value;

  const socialHandle = document.getElementById("social-handle").value.trim();

  const age = document.getElementById("age").value.trim();

  let profilePic = document.getElementById("profile-pic").value.trim();

  const termsConfirmed = document.getElementById("terms-confirm").checked;

  if (!termsConfirmed) {

    alert("You must confirm that you are 18 years or older and agree to the Terms of Use and Privacy Policy.");

    return;

  }

  const loveLanguagesSelect = document.getElementById("pref-loveLanguages");

  const selectedLoveLanguages = Array.from(loveLanguagesSelect.options).filter(option => option.selected).map(option => option.value);

  if (selectedLoveLanguages.length === 0) {

    alert("Please select at least one love language.");

    return;

  }

  const hobbiesSelect = document.getElementById("pref-hobbies");

  const selectedHobbies = Array.from(hobbiesSelect.options).filter(option => option.selected).map(option => option.value);

  if (selectedHobbies.length === 0) {

    alert("Please select at least one hobby.");

    return;

  }

  const dealBreakersSelect = document.getElementById("pref-dealBreakers");

  const selectedDealBreakers = Array.from(dealBreakersSelect.options).filter(option => option.selected).map(option => option.value);

  if (selectedDealBreakers.length === 0) {

    alert("Please select at least one deal breaker.");

    return;

  }

  const isDuplicate = signedUpUsers.some(user => user.nickname === nickname && user.socialHandle === socialHandle);

  if (isDuplicate) {

    alert("You have already signed up for a balloon spot!");

    return;

  }

  const newCandidate = {

    nickname, gender, platform, socialHandle, age, profilePic,

    loveLanguages: selectedLoveLanguages,

    hobbies: selectedHobbies,

    dealBreakers: selectedDealBreakers,

    isRealSignup: true, matchedWith: [], fullHearts: 0, brokenHearts: 0,

    isSimulated: false, isSubscribed: false, adFree: false

  };

  

  const fileInput = document.getElementById("profile-pic-upload");

  if (fileInput.files && fileInput.files[0]) {

    const reader = new FileReader();

    reader.onload = function(e) {

      newCandidate.profilePic = e.target.result;

      finishSignUp(newCandidate);

    }

    reader.readAsDataURL(fileInput.files[0]);

  } else {

    finishSignUp(newCandidate);

  }

  

  function finishSignUp(candidate) {

    currentPlayerData = candidate;

    localStorage.setItem("playerData", JSON.stringify(candidate));

    signedUpUsers.push(candidate);

    alert("Sign-up successful! Your data has been saved and you are now logged in.");

    const urlParams = new URLSearchParams(window.location.search);

    if(urlParams.has("ref")) {

      popsRemaining += 6;

      keepsRemaining += 2;

      alert("Invitation reward: You've received 6 pops and 2 keeps for joining via invitation!");

    }

    // Try to assign a free balloon spot that is not beyond the halfway point.

    let assigned = false;

    for (let x = 0; x < gridWidth; x++) {

      for (let y = 0; y < gridHeight; y++) {

        if (!balloons[x][y].user && y < gridHeight/2) {

          balloons[x][y].user = candidate;

          assigned = true;

          break;

        }

      }

      if (assigned) break;

    }

    if (!assigned) {

      if (candidate.gender === "male") {

        waitlistMale.push(candidate);

      } else {

        waitlistFemale.push(candidate);

      }

    }

    signupModal.style.display = "none";

    assignBalloonSpots();

  }

});



subscribeBtn.addEventListener("click", () => {

  if (!currentPlayerData) {

    alert("Please sign up first to subscribe.");

    return;

  }

  if (currentPlayerData.isSubscribed) {

    alert("You are already subscribed.");

    return;

  }

  if (confirm("Start a free 3-day trial subscription? (You will be charged after the trial period)")) {

    processPayment(0, "Free 3-day trial subscription", (success) => {

      if (success) {

        currentPlayerData.isSubscribed = "trial";

        currentPlayerData.trialExpiry = Date.now() + 3 * 24 * 60 * 60 * 1000;

        popsRemaining = 9999;

        keepsRemaining = 10;

        popCountDisplay.textContent = "Pops Remaining: Unlimited";

        keepCountDisplay.textContent = "Keeps Remaining: 10";

        alert("Trial Subscription activated! Enjoy 3 days free.");

      } else {

        alert("Payment failed.");

      }

    });

  } else {

    const tier = prompt("Choose Subscription Tier:\nEnter 1 for Basic ($4.99/month – Unlimited pops, 10 keeps)\nEnter 2 for Premium ($9.99/month – Unlimited pops & keeps)");

    if (tier === "1") {

      processPayment(4.99, "Basic Subscription", (success) => {

        if (success) {

          currentPlayerData.isSubscribed = "basic";

          popsRemaining = 9999;

          keepsRemaining = 10;

          popCountDisplay.textContent = "Pops Remaining: Unlimited";

          keepCountDisplay.textContent = "Keeps Remaining: 10";

          alert("Basic Subscription activated!");

        } else {

          alert("Payment failed.");

        }

      });

    } else if (tier === "2") {

      processPayment(9.99, "Premium Subscription", (success) => {

        if (success) {

          currentPlayerData.isSubscribed = "premium";

          popsRemaining = 9999;

          keepsRemaining = 9999;

          popCountDisplay.textContent = "Pops Remaining: Unlimited";

          keepCountDisplay.textContent = "Keeps Remaining: Unlimited";

          alert("Premium Subscription activated!");

        } else {

          alert("Payment failed.");

        }

      });

    } else {

      alert("Invalid selection. Subscription canceled.");

    }

  }

});



// Modified Remove Ads: after successful removal, the sponsored simulated user is removed from the balloon room.

removeAdsBtn.addEventListener("click", () => {

  if (!currentPlayerData) {

    alert("Please sign up first to remove ads.");

    return;

  }

  if (currentPlayerData.adFree) {

    alert("Ads have already been removed.");

    return;

  }

  if (confirm("Pay a one-time fee to remove ads permanently?")) {

    processPayment(5, "Remove Ads", (success) => {

      if(success) {

        currentPlayerData.adFree = true;

        alert("Ads removed! Enjoy an ad-free experience.");

        for (let x = 0; x < gridWidth; x++) {

          for (let y = 0; y < gridHeight; y++) {

            let cell = balloons[x][y];

            if (cell.user && cell.user.isSimulated && cell.user.gender === "sponsored") {

              let sponsoredUser = cell.user;

              cell.user = null;

              waitlistMale.push(sponsoredUser);

            }

          }

        }

        renderBalloons();

      } else {

        alert("Payment failed.");

      }

    });

  }

});



coffeeBundleBtn.addEventListener("click", () => {

  if (!currentPlayerData) {

    alert("Please sign up first to buy a coffee bundle.");

  } else if (confirm("Buy Coffee Bundle: 10 pops and 5 keeps for $10?")) {

    processPayment(10, "Coffee Bundle", (success) => {

      if(success) {

        popsRemaining += 10;

        keepsRemaining += 5;

        popCountDisplay.textContent = `Pops Remaining: ${popsRemaining}`;

        keepCountDisplay.textContent = `Keeps Remaining: ${keepsRemaining}`;

        alert("Coffee bundle purchased! Extra pops and keeps added.");

      } else {

        alert("Payment failed.");

      }

    });

  }

});



watchAdBtn.addEventListener("click", () => {

  if (!currentPlayerData) {

    alert("Please sign up first to watch ads.");

  } else if (currentPlayerData.adFree) {

    alert("You have removed ads.");

  } else if (confirm("Watch a rewarded ad for extra pops/keeps?")) {

    setTimeout(() => {

      popsRemaining += 3;

      keepsRemaining += 1;

      popCountDisplay.textContent = `Pops Remaining: ${popsRemaining}`;

      keepCountDisplay.textContent = `Keeps Remaining: ${keepsRemaining}`;

      alert("Ad watched! You've earned extra pops and keeps.");

    }, 2000);

  }

});



searchBtn.addEventListener("click", () => {

  const coords = searchInput.value.trim().split(",");

  if (coords.length !== 2) { alert("Please enter coordinates in the format x,y"); return; }

  const x = parseInt(coords[0]);

  const y = parseInt(coords[1]);

  if (isNaN(x) || isNaN(y) || x < 0 || y < 0 || x >= gridWidth || y >= gridHeight) {

    alert("Invalid coordinates. Please try again.");

    return;

  }

  const targetRoom = Math.floor(y / roomRows) + 1;

  currentRoom = targetRoom;

  roomIndicator.textContent = `Balloon Room ${currentRoom} of ${totalRooms}`;

  initRoomGrid();

  renderBalloons();

  if (gridCells[x] && gridCells[x][y]) {

    const cell = gridCells[x][y];

    cell.classList.add("highlight");

    setTimeout(() => { cell.classList.remove("highlight"); }, 3000);

  }

});



rentBtn.addEventListener("click", () => {

  const coords = searchInput.value.trim().split(",");

  if (coords.length !== 2) { alert("Please enter coordinates in the format x,y"); return; }

  const x = parseInt(coords[0]);

  const y = parseInt(coords[1]);

  if (isNaN(x) || isNaN(y) || x < 0 || y < 0 || x >= gridWidth || y >= gridHeight) {

    alert("Invalid coordinates. Please try again.");

    return;

  }

  bookSpot(x, y);

});



setInterval(updateResetTimer, 1000);

setInterval(updateWaitlistStatus, 1000);



simulateBalloons();

initRoomGrid();



// Function to add simulated users, checking for ad-free status for sponsored user.

function addSimulatedUsers() {

  simulatedUsers.forEach(user => {

    if (user.gender === "sponsored" && currentPlayerData && currentPlayerData.adFree) {

      waitlistMale.push(user);

      return;

    }

    let assigned = false;

    for (let x = 0; x < gridWidth; x++) {

      for (let y = 0; y < roomRows; y++) {

        if (!balloons[x][y].user) {

          balloons[x][y].user = user;

          assigned = true;

          break;

        }

      }

      if (assigned) break;

    }

    if (!assigned) {

      if (user.gender === "male") { waitlistMale.push(user); }

      else { waitlistFemale.push(user); }

    }

    signedUpUsers.push(user);

  });

  simulatedUsersAdded = true;

}



// Add simulated users on initial load.

if (!simulatedUsersAdded) {

  addSimulatedUsers();

}



// If a real user is already logged in, try to assign their balloon spot immediately if free and within the first half of the grid.

if (currentPlayerData) {

  let assigned = false;

  for (let x = 0; x < gridWidth; x++) {

    for (let y = 0; y < gridHeight; y++) {

      if (!balloons[x][y].user && y < gridHeight/2) {

        balloons[x][y].user = currentPlayerData;

        assigned = true;

        break;

      }

    }

    if (assigned) break;

  }

  if (!assigned) {

    if (currentPlayerData.gender === "male") { waitlistMale.push(currentPlayerData); }

    else { waitlistFemale.push(currentPlayerData); }

  }

}



renderBalloons();

updateLeaderboard();

updateTicker();



// handleSimulatedAd remains unchanged – only the sponsored simulated user shows the ad prompt.

function handleSimulatedAd(balloon) {

  if (!currentPlayerData) { alert("Please sign up to watch rewarded ads."); return; }

  if (currentPlayerData.adFree) { alert("You have removed ads."); return; }

  if (confirm("This is a sponsored ad. Would you like to watch a rewarded video for extra pops/keeps?")) {

    setTimeout(() => {

      popsRemaining += 3;

      keepsRemaining += 1;

      popCountDisplay.textContent = `Pops Remaining: ${popsRemaining}`;

      keepCountDisplay.textContent = `Keeps Remaining: ${keepsRemaining}`;

      alert("Ad watched! You've earned extra pops and keeps.");

    }, 2000);

  }

}   

  </script>

</body>

</html>

